<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>3D File Format Converter</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script type="importmap">
    {
      "imports": {
        "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
        "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/"
      }
    }
  </script>
</head>
<body>
  <div id="root"></div>

  <script type="module">
    import * as THREE from 'three';
    import { OBJLoader } from 'three/addons/loaders/OBJLoader.js';
    import { STLLoader } from 'three/addons/loaders/STLLoader.js';
    import { PLYLoader } from 'three/addons/loaders/PLYLoader.js';
    import { GLTFLoader } from 'three/addons/loaders/GLTFLoader.js';
    import { OBJExporter } from 'three/addons/exporters/OBJExporter.js';
    import { STLExporter } from 'three/addons/exporters/STLExporter.js';
    import { PLYExporter } from 'three/addons/exporters/PLYExporter.js';
    import { GLTFExporter } from 'three/addons/exporters/GLTFExporter.js';

    class FormatConverter {
      constructor() {
        this.file = null;
        this.outputFormat = 'gltf';
        this.isProcessing = false;
        this.supportedFormats = {
          input: ['obj', 'stl', 'ply', 'gltf', 'glb'],
          output: ['gltf', 'glb', 'obj', 'stl', 'ply']
        };
        this.init();
      }

      init() {
        document.getElementById('file-upload').addEventListener('change', (e) => this.handleFileUpload(e));
        document.getElementById('output-format').addEventListener('change', (e) => {
          this.outputFormat = e.target.value;
        });
        document.getElementById('convert-btn').addEventListener('click', () => this.handleConvert());
      }

      handleFileUpload(e) {
        this.file = e.target.files[0];
        if (this.file) {
          document.getElementById('file-name').textContent = this.file.name;
          this.setStatus('', 'info');
        }
      }

      setStatus(message, type = 'info') {
        const statusDiv = document.getElementById('status');
        const statusText = document.getElementById('status-text');
        const statusIcon = document.getElementById('status-icon');
        
        if (!message) {
          statusDiv.classList.add('hidden');
          return;
        }

        statusDiv.classList.remove('hidden');
        statusText.textContent = message;

        statusDiv.className = 'flex items-start gap-3 p-4 rounded-lg ';
        if (type === 'error') {
          statusDiv.className += 'bg-red-500/20 border border-red-400/30';
          statusIcon.innerHTML = '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="text-red-300"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></svg>';
        } else if (type === 'success') {
          statusDiv.className += 'bg-green-500/20 border border-green-400/30';
          statusIcon.innerHTML = '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="text-green-300"><polyline points="20 6 9 17 4 12"/></svg>';
        } else {
          statusDiv.className += 'bg-blue-500/20 border border-blue-400/30';
          statusIcon.innerHTML = '<svg class="animate-spin text-blue-300" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 12a9 9 0 1 1-6.219-8.56"/></svg>';
        }
      }

      async parseOBJ(text) {
        const loader = new OBJLoader();
        return loader.parse(text);
      }

      async parseSTL(buffer) {
        const loader = new STLLoader();
        const geometry = loader.parse(buffer);
        const material = new THREE.MeshStandardMaterial({ color: 0x888888 });
        const mesh = new THREE.Mesh(geometry, material);
        const scene = new THREE.Scene();
        scene.add(mesh);
        return scene;
      }

      async parsePLY(buffer) {
        const loader = new PLYLoader();
        const geometry = loader.parse(buffer);
        const material = new THREE.MeshStandardMaterial({ color: 0x888888 });
        const mesh = new THREE.Mesh(geometry, material);
        const scene = new THREE.Scene();
        scene.add(mesh);
        return scene;
      }

      async parseGLTF(buffer) {
        return new Promise((resolve, reject) => {
          const loader = new GLTFLoader();
          loader.parse(buffer, '', (gltf) => {
            resolve(gltf.scene);
          }, reject);
        });
      }

      async exportToGLTF(scene) {
        const exporter = new GLTFExporter();
        return new Promise((resolve) => {
          exporter.parse(scene, (result) => {
            const output = JSON.stringify(result, null, 2);
            resolve(new Blob([output], { type: 'application/json' }));
          }, () => {}, { binary: false });
        });
      }

      async exportToGLB(scene) {
        const exporter = new GLTFExporter();
        return new Promise((resolve) => {
          exporter.parse(scene, (result) => {
            resolve(new Blob([result], { type: 'application/octet-stream' }));
          }, () => {}, { binary: true });
        });
      }

      exportToOBJ(scene) {
        const exporter = new OBJExporter();
        const result = exporter.parse(scene);
        return new Blob([result], { type: 'text/plain' });
      }

      exportToSTL(scene) {
        const exporter = new STLExporter();
        const result = exporter.parse(scene);
        return new Blob([result], { type: 'application/octet-stream' });
      }

      async exportToPLY(scene) {
        const exporter = new PLYExporter();
        return new Promise((resolve) => {
          exporter.parse(scene, (result) => {
            resolve(new Blob([result], { type: 'text/plain' }));
          }, { binary: false });
        });
      }

      getFileExtension(filename) {
        return filename.split('.').pop().toLowerCase();
      }

      async handleConvert() {
        if (!this.file) {
          this.setStatus('Please select a file first', 'error');
          return;
        }

        if (this.isProcessing) return;

        this.isProcessing = true;
        const btn = document.getElementById('convert-btn');
        btn.disabled = true;
        btn.innerHTML = '<svg class="animate-spin" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 12a9 9 0 1 1-6.219-8.56"/></svg> Converting...';
        
        this.setStatus('Processing...', 'info');

        try {
          const ext = this.getFileExtension(this.file.name);
          let loadedScene;

          if (ext === 'obj') {
            const text = await this.file.text();
            loadedScene = await this.parseOBJ(text);
          } else if (ext === 'stl') {
            const buffer = await this.file.arrayBuffer();
            loadedScene = await this.parseSTL(buffer);
          } else if (ext === 'ply') {
            const buffer = await this.file.arrayBuffer();
            loadedScene = await this.parsePLY(buffer);
          } else if (ext === 'gltf' || ext === 'glb') {
            const buffer = await this.file.arrayBuffer();
            loadedScene = await this.parseGLTF(buffer);
          } else {
            this.setStatus(`Input format .${ext} not supported. Supported: ${this.supportedFormats.input.join(', ')}`, 'error');
            this.isProcessing = false;
            btn.disabled = false;
            btn.innerHTML = '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4M7 10l5 5 5-5M12 15V3"/></svg> Convert & Download';
            return;
          }

          let blob;
          let outputExt = this.outputFormat;

          if (this.outputFormat === 'gltf') {
            blob = await this.exportToGLTF(loadedScene);
          } else if (this.outputFormat === 'glb') {
            blob = await this.exportToGLB(loadedScene);
          } else if (this.outputFormat === 'obj') {
            blob = this.exportToOBJ(loadedScene);
          } else if (this.outputFormat === 'stl') {
            blob = this.exportToSTL(loadedScene);
          } else if (this.outputFormat === 'ply') {
            blob = await this.exportToPLY(loadedScene);
          }

          const url = URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.download = `${this.file.name.split('.')[0]}_converted.${outputExt}`;
          document.body.appendChild(a);
          a.click();
          document.body.removeChild(a);
          URL.revokeObjectURL(url);

          this.setStatus('Conversion successful! Download started.', 'success');
        } catch (error) {
          console.error(error);
          this.setStatus(`Error: ${error.message}`, 'error');
        } finally {
          this.isProcessing = false;
          btn.disabled = false;
          btn.innerHTML = '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4M7 10l5 5 5-5M12 15V3"/></svg> Convert & Download';
        }
      }
    }

    // Initialize the converter when DOM is loaded
    new FormatConverter();
  </script>

  <!-- Static HTML structure -->
  <div class="min-h-screen bg-gradient-to-br from-slate-900 via-purple-900 to-slate-900 p-8">
    <div class="max-w-2xl mx-auto">
      <div class="bg-white/10 backdrop-blur-lg rounded-2xl shadow-2xl p-8 border border-white/20">
        <h1 class="text-4xl font-bold text-white mb-2 text-center">
          3D File Converter
        </h1>
        <p class="text-purple-200 text-center mb-8">
          Convert between OBJ, STL, PLY, GLTF, and GLB formats
        </p>

        <div class="space-y-6">
          <div>
            <label class="block text-white font-medium mb-3">
              Upload 3D File
            </label>
            <div class="relative">
              <input
                type="file"
                accept=".obj,.stl,.ply,.gltf,.glb"
                class="hidden"
                id="file-upload"
              />
              <label
                for="file-upload"
                class="flex items-center justify-center w-full p-6 border-2 border-dashed border-purple-400 rounded-lg cursor-pointer hover:border-purple-300 hover:bg-white/5 transition-all"
              >
                <div class="text-center">
                  <svg class="mx-auto h-12 w-12 text-purple-300 mb-2" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4M17 8l-5-5-5 5M12 3v12"/>
                  </svg>
                  <span class="text-white" id="file-name">Click to upload or drag and drop</span>
                  <p class="text-purple-300 text-sm mt-1">
                    Supported: OBJ, STL, PLY, GLTF, GLB
                  </p>
                </div>
              </label>
            </div>
          </div>

          <div>
            <label class="block text-white font-medium mb-3">
              Output Format
            </label>
            <select
              id="output-format"
              class="w-full px-4 py-3 bg-white/10 border border-white/20 rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-purple-400"
            >
              <option value="gltf">GLTF (.gltf)</option>
              <option value="glb">GLB (.glb)</option>
              <option value="obj">OBJ (.obj)</option>
              <option value="stl">STL (.stl)</option>
              <option value="ply">PLY (.ply)</option>
            </select>
          </div>

          <button
            id="convert-btn"
            class="w-full bg-gradient-to-r from-purple-500 to-pink-500 text-white font-semibold py-4 px-6 rounded-lg hover:from-purple-600 hover:to-pink-600 disabled:opacity-50 disabled:cursor-not-allowed transition-all flex items-center justify-center gap-2"
          >
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4M7 10l5 5 5-5M12 15V3"/>
            </svg>
            Convert & Download
          </button>

          <div id="status" class="hidden">
            <div id="status-icon"></div>
            <p class="text-white text-sm" id="status-text"></p>
          </div>
        </div>

        <div class="mt-8 pt-6 border-t border-white/10">
          <h3 class="text-white font-medium mb-3">How to use:</h3>
          <ol class="text-purple-200 text-sm space-y-2">
            <li>1. Upload your 3D file (OBJ, STL, PLY, GLTF, or GLB)</li>
            <li>2. Select your desired output format</li>
            <li>3. Click "Convert & Download" to get your converted file</li>
          </ol>
        </div>
      </div>

      <p class="text-center text-purple-300 text-sm mt-6">
        All processing happens in your browser - your files are never uploaded to a server
      </p>
    </div>
  </div>
</body>
</html>
